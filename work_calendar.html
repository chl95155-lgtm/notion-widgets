<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Yellow Work Calendar - Final Fix</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { --main-yellow: #FBC02D; --soft-yellow: #FFF9C4; --bg-yellow: #FFFDE7; }
        body { background: transparent; font-family: 'Pretendard', sans-serif; margin: 0; padding: 10px; }
        .container { background: white; border: 3px solid var(--main-yellow); border-radius: 25px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--soft-yellow); padding-bottom: 10px; margin-bottom: 15px; }
        .header h2 { color: #5D4037; margin: 0; font-size: 18px; }
        .btn-auth { background: var(--main-yellow); color: white; border: none; padding: 10px 18px; border-radius: 12px; cursor: pointer; font-weight: bold; }
        .btn-auth:disabled { background: #eee; color: #aaa; }
        .status-box { font-size: 12px; padding: 10px; border-radius: 8px; margin-bottom: 10px; background: #f8f9fa; line-height: 1.6; text-align: left; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2>ğŸ’› ì—…ë¬´ ì¼ì • (ìµœì¢… ì ê²€)</h2>
        <button id="auth_button" class="btn-auth" onclick="handleAuthClick()" disabled>ì¤€ë¹„ ì¤‘...</button>
    </div>
    <div id="debug_status" class="status-box">
        â³ ì‹œìŠ¤í…œ ì—”ì§„ ê°€ë™ ì¤‘...<br>
        - êµ¬ê¸€ API ì—”ì§„: <span id="gapi_status">í™•ì¸ ì¤‘...</span><br>
        - ë¡œê·¸ì¸ ì‹œìŠ¤í…œ: <span id="gis_status">í™•ì¸ ì¤‘...</span>
    </div>
    <div id="content"></div>
</div>

<script>
    const CLIENT_ID = '582944285891-2benf275reb6i2o64d0bk5eh67okjlov.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDx-J1xtz2c1X7F7CZg1VKVbmlScDkBg8s';
    
    const CALENDAR_IDS = [
        'primary', '2ajtn021gaspbcms3vt8lnlqo@group.calendar.google.com', 
        'chl95155@gmail.com', 'f45f8eb9f500085735d5c1d118b77c00d01462f269d4601a7fe40244fa213ed2@group.calendar.google.com', 
        'ko.south_korea#holiday@group.v.calendar.google.com'
    ];

    let tokenClient;
    let gapiInited = false;

    // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ìƒíƒœë¥¼ ê°•ì œë¡œ ì²´í¬í•˜ëŠ” íƒ€ì´ë¨¸
    const checkInterval = setInterval(() => {
        if (typeof gapi !== 'undefined' && !gapiInited) {
            gapi.load('client', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"] });
                gapiInited = true;
                document.getElementById('gapi_status').innerHTML = '<span class="success">âœ… ì—°ê²° ì™„ë£Œ</span>';
                checkReady();
            });
        }
        if (typeof google !== 'undefined' && google.accounts && !tokenClient) {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: 'https://www.googleapis.com/auth/calendar.readonly', callback: '',
            });
            document.getElementById('gis_status').innerHTML = '<span class="success">âœ… ì—°ê²° ì™„ë£Œ</span>';
            checkReady();
        }
    }, 1000);

    function checkReady() {
        if (gapiInited && tokenClient) {
            clearInterval(checkInterval);
            const btn = document.getElementById('auth_button');
            btn.innerText = 'ë¡œê·¸ì¸';
            btn.disabled = false;
        }
    }

    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error) return;
            document.getElementById('auth_button').innerText = 'ë™ê¸°í™” ì™„ë£Œ';
            await listUpcomingEvents();
        };
        tokenClient.requestAccessToken({prompt: 'consent'});
    }

    async function listUpcomingEvents() {
        let allEvents = [];
        for (const id of CALENDAR_IDS) {
            try {
                const response = await gapi.client.calendar.events.list({
                    'calendarId': id, 'timeMin': (new Date()).toISOString(), 'showDeleted': false, 'singleEvents': true, 'maxResults': 5, 'orderBy': 'startTime'
                });
                if (response.result.items) allEvents = allEvents.concat(response.result.items);
            } catch(e) {}
        }
        allEvents.sort((a, b) => new Date(a.start.dateTime || a.start.date) - new Date(b.start.dateTime || b.start.date));
        document.getElementById('content').innerHTML = allEvents.map(event => `
            <div style="background:#FFFDE7; border-left:5px solid #FBC02D; padding:10px; margin-bottom:8px; border-radius:8px; text-align:left;">
                <div style="font-size:11px; color:#795548;">${new Date(event.start.dateTime || event.start.date).toLocaleString('ko-KR', {hour:'2-digit', minute:'2-digit'})}</div>
                <div style="font-size:13px; color:#3E2723; font-weight:500;">${event.summary}</div>
            </div>
        `).join('') || 'ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.';
    }
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
</body>
</html>
